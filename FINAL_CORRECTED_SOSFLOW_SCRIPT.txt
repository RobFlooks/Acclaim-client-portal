# SOSFLOW 1.4 - FINAL CORRECTED DOCUMENT UPLOAD
#Hash final_corrected_document_upload_script
#ModifiedBy CHADLAW\Matt.Perry on vm-uks-sh-18
#LastSave 18/07/2025 17:10:00

SelectDocument SelectDocument1
	Centred False
	Location main_area
	MessageType Information
	CardPosX 10
	CardPosY -110
	GOTO SetVariables2

DoNothing DoNothing1
	CardPosX 290
	CardPosY 130

Message Message2
	Message The Portal has been updated successfully
	Centred True
	Location system_tray
	MessageType Information
	CardPosX 510
	CardPosY 70

SetVariables SetVariables2
	Initializations
		#Authentication
		organisation_id = 3
		username = 'acclaim.orgadmin@acclaim.law'
		password = 'Chadw1ck816!!'
		
		external_case_ref = 'Ref ' + ConnectApp.System.Firmsname + ":" + matter.entitytype + ":" + matter.entityref
		external_case_ref_encoded = replace(external_case_ref," ","_")
		
		url = 'https://cb46d52f-84a8-405f-910d-210c6969a262-00-3p04s4dzuvkyp.spock.replit.dev/api/external/cases/' + external_case_ref_encoded + '/documents'
		
		count_of_files = SelectDocument1.SelectedDocuments.count
		
		if count_of_files >= 1 then file_1_name = SelectDocument1.SelectedDocuments(0).description + SelectDocument1.SelectedDocuments(0).fileext
		if count_of_files >= 1 then file_1_type = 'application/ms-word'
		if count_of_files >= 1 then file_1 = SelectDocument1.SelectedDocuments(0).doc_name
		
	CardPosX 10
	CardPosY 250
	GOTO PythonScript1

PythonScript PythonScript1
	InputVars url,external_case_ref_encoded,count_of_files,file_1_name,file_1_type,file_1
	OutputVars response
	Source
		import System
		from System import *
		from System.Text import *
		from System.IO import *
		
		import clr
		clr.AddReference("System.Xml")
		from System.Xml import *
		clr.AddReference("System.Web")
		from System.Web import *
		clr.AddReference("System.Net")
		from System.Net import WebRequest
		
		try:
			# Check if file was selected
			if count_of_files < 1:
				response = "Error: No file selected for upload"
			else:
				boundary = '----------' + System.DateTime.Now.Ticks.ToString('x')
			
				web_request = WebRequest.Create(url)
				web_request.ContentType = 'multipart/form-data; boundary=' + boundary
				web_request.Method = 'POST'
			
				# Build form data as string - NO STRINGBUILDER to avoid .NET type conflicts
				form_data = '--' + boundary + '\r\n'
				form_data += 'Content-Disposition: form-data; name="fileName"\r\n'
				form_data += '\r\n'
				form_data += str(file_1_name) + '\r\n'
				
				form_data += '--' + boundary + '\r\n'
				form_data += 'Content-Disposition: form-data; name="documentType"\r\n'
				form_data += '\r\n'
				form_data += 'correspondence\r\n'
				
				form_data += '--' + boundary + '\r\n'
				form_data += 'Content-Disposition: form-data; name="description"\r\n'
				form_data += '\r\n'
				form_data += 'Document uploaded from SOS for case: ' + str(external_case_ref_encoded) + '\r\n'
				
				form_data += '--' + boundary + '\r\n'
				form_data += 'Content-Disposition: form-data; name="document"; filename="' + str(file_1_name) + '"\r\n'
				form_data += 'Content-Type: ' + str(file_1_type) + '\r\n'
				form_data += '\r\n'
			
				post_header_bytes = Encoding.UTF8.GetBytes(form_data)
				boundary_bytes = Encoding.ASCII.GetBytes('\r\n--' + boundary + '--\r\n')
			
				file_stream = FileStream(file_1, FileMode.Open, FileAccess.Read)
				length = post_header_bytes.Length + file_stream.Length + boundary_bytes.Length
			
				web_request.ContentLength = length
				request_stream = web_request.GetRequestStream()
			
				# Write form header
				request_stream.Write(post_header_bytes, 0, post_header_bytes.Length)
			
				# Write file content
				buffer = Array.CreateInstance(System.Byte, 4096)
				while True:
					bytes_read = file_stream.Read(buffer, 0, buffer.Length)
					if bytes_read == 0:
						break
					request_stream.Write(buffer, 0, bytes_read)
			
				# Write boundary footer
				request_stream.Write(boundary_bytes, 0, boundary_bytes.Length)
				
				# Close streams
				file_stream.Close()
				request_stream.Close()
			
				# Get response
				r = web_request.GetResponse()
				s = r.GetResponseStream()
				sr = StreamReader(s)
				response = sr.ReadToEnd()
				
				# Close response streams
				sr.Close()
				s.Close()
				r.Close()
				
				response = "Upload successful: " + response
		
		except System.Net.WebException, e:
			response = "WebException: " + str(e.Message)
		except System.Exception, e:
			response = "Exception: " + str(e.Message)
	CardPosX 210
	CardPosY 250
	GOTO Message2