# SOSFLOW 1.4
#Hash 0eb6f4de0b92dd2fe03f60a192dba377
#ModifiedBy CHADLAW\Matt.Perry on vm-uks-sh-20
#LastSave 19/07/2025 19:13:37
SelectFile SelectFile1
	Centred False
	Location main_area
	MessageType Information
	CardPosX 10
	CardPosY -110
	GOTO SetVariables2

DoNothing DoNothing1
	CardPosX 290
	CardPosY 130

SetVariables SetVariables2
	Initializations
		organisation_id = 3
		username = 'acclaim.orgadmin@acclaim.law'
		password = 'Chadw1ck816!!'
				
		external_case_ref = 'Ref ' + ConnectApp.System.Firmsname + ":" + matter.entitytype + ":" + matter.entityref
		external_case_ref_encoded = replace(external_case_ref," ","_")
				
		url = 'https://cb46d52f-84a8-405f-910d-210c6969a262-00-3p04s4dzuvkyp.spock.replit.dev/api/external/cases/' + external_case_ref_encoded + '/documents'
				
		count_of_files = 1
				
		#if count_of_files = 1 then file_1_name = SelectDocument1.SelectedFiles(0).name
		#if count_of_files = 1 then file_1_type = SelectDocument1.SelectedFiles(0).contenttype
		#if count_of_files = 1 then file_1 = SelectDocument1.SelectedFiles(0).fullpath
		
		
		if count_of_files = 1 then file_1_name = SelectFile1.filename
		if count_of_files = 1 then file_1_type = 'application/ms-word'
		if count_of_files = 1 then file_1 = SelectFile1.filename
		
		
		file1 = file_1_name
	CardPosX 10
	CardPosY 250
	GOTO PythonScript1

PythonScript PythonScript1
	InputVars url,external_case_ref_encoded,count_of_files,file_1_name,file_1_type,file_1
	OutputVars response
	Source
		import System
		from System import *
		from System.Text import *
		from System.IO import *
		import clr
		clr.AddReference("System.Net")
		from System.Net import WebRequest
		
		response = "DEBUG INFO:\n"
		response = response + "Files selected: " + str(count_of_files) + "\n"
		response = response + "File name: '" + str(file_1_name) + "'\n"
		response = response + "File type: '" + str(file_1_type) + "'\n"
		response = response + "File path: '" + str(file_1) + "'\n"
		response = response + "URL: " + str(url) + "\n\n"
		
		try:
		    if count_of_files < 1:
		        response = response + "ERROR: No file selected for upload"
		    else:
		        # Handle filename properly for SelectFile
		        actual_filename = str(file_1_name) if file_1_name != "None" and file_1_name is not None and str(file_1_name) != "" else "Document_from_SOS.txt"
		        actual_filetype = str(file_1_type) if file_1_type != "None" and file_1_type is not None and str(file_1_type) != "" else "application/octet-stream"
		        
		        response = response + "Using filename: '" + actual_filename + "'\n"
		        response = response + "Using filetype: '" + actual_filetype + "'\n\n"
		        
		        boundary = "----------12345678901234567890"
		        
		        web_request = WebRequest.Create(url)
		        web_request.ContentType = "multipart/form-data; boundary=" + boundary
		        web_request.Method = "POST"
		        
		        form_data = "--" + boundary + "\r\n"
		        form_data = form_data + "Content-Disposition: form-data; name=\"fileName\"\r\n"
		        form_data = form_data + "\r\n"
		        form_data = form_data + actual_filename + "\r\n"
		        
		        form_data = form_data + "--" + boundary + "\r\n"
		        form_data = form_data + "Content-Disposition: form-data; name=\"documentType\"\r\n"
		        form_data = form_data + "\r\n"
		        form_data = form_data + "correspondence\r\n"
		        
		        form_data = form_data + "--" + boundary + "\r\n"
		        form_data = form_data + "Content-Disposition: form-data; name=\"description\"\r\n"
		        form_data = form_data + "\r\n"
		        form_data = form_data + "Document uploaded from SOS case management system\r\n"
		        
		        form_data = form_data + "--" + boundary + "\r\n"
		        form_data = form_data + "Content-Disposition: form-data; name=\"document\"; filename=\"" + actual_filename + "\"\r\n"
		        form_data = form_data + "Content-Type: " + actual_filetype + "\r\n"
		        form_data = form_data + "\r\n"
		        
		        post_header_bytes = Encoding.UTF8.GetBytes(form_data)
		        boundary_bytes = Encoding.ASCII.GetBytes("\r\n--" + boundary + "--\r\n")
		        
		        file_stream = FileStream(file_1, FileMode.Open, FileAccess.Read)
		        length = post_header_bytes.Length + file_stream.Length + boundary_bytes.Length
		        
		        web_request.ContentLength = length
		        request_stream = web_request.GetRequestStream()
		        
		        request_stream.Write(post_header_bytes, 0, post_header_bytes.Length)
		        
		        buffer = Array.CreateInstance(System.Byte, 4096)
		        while True:
		            bytes_read = file_stream.Read(buffer, 0, buffer.Length)
		            if bytes_read == 0:
		                break
		            request_stream.Write(buffer, 0, bytes_read)
		        
		        request_stream.Write(boundary_bytes, 0, boundary_bytes.Length)
		        
		        file_stream.Close()
		        request_stream.Close()
		        
		        response = response + "Request sent successfully!\n"
		        
		        r = web_request.GetResponse()
		        s = r.GetResponseStream()
		        sr = StreamReader(s)
		        server_response = sr.ReadToEnd()
		        
		        sr.Close()
		        s.Close()
		        r.Close()
		        
		        response = response + "SUCCESS: " + actual_filename + " (" + actual_filetype + ") uploaded\n"
		        response = response + "Server response: " + server_response
		
		except System.Net.WebException as e:
		    response = response + "WebException: " + str(e.Message)
		except System.Exception as e:
		    response = response + "Exception: " + str(e.Message)
	CardPosX 210
	CardPosY 250
	GOTO DoNothing1

