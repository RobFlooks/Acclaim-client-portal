# SOSFLOW 1.4 - FIXED FORM-ENCODED VERSION
# Properly formatted for application/x-www-form-urlencoded with Express.js

DoNothing DoNothing1
	CardPosX 10
	CardPosY -110
	GOTO SetVariables1

SetVariables SetVariables1
	Initializations
		# API endpoint
		url = 'https://cb46d52f-84a8-405f-910d-210c6969a262-00-3p04s4dzuvkyp.spock.replit.dev/api/external/cases'
		
		# Clean external reference - avoid all special characters
		external_ref = 'SOS_' + replace(replace(matter.entityref,'-','_'),' ','_')
		
		# Organisation reference
		org_ref = 'CHADLAW001'
		
		# URL encode values that might contain spaces or special characters
		acc_num = replace(replace(matter.entityref,'-','_'),' ','_')
		case_nm = replace(replace(replace(matter.mattername,' ','%20'),'-','_'),'&','%26')
		assigned_to = replace(replace(matter.feeearner,' ','%20'),'-','_')
		
		# Fixed required fields
		debtor_type = 'individual'
		case_status = 'active'
		case_stage = 'pre_legal'
		orig_amount = '0.00'
		outstanding = '0.00'
	CardPosX 10
	CardPosY 50
	GOTO HTTPPost1

HTTPPost HTTPPost1
	URL url
	ContentType application/x-www-form-urlencoded
	PostData 'externalRef=' + external_ref + '&organisationExternalRef=' + org_ref + '&accountNumber=' + acc_num + '&caseName=' + case_nm + '&debtorType=' + debtor_type + '&status=' + case_status + '&stage=' + case_stage + '&assignedTo=' + assigned_to + '&originalAmount=' + orig_amount + '&outstandingAmount=' + outstanding
	ResponseVariable response_text
	StatusCodeVariable status_code
	CardPosX 210
	CardPosY 50
	GOTO Message1

Message Message1
	Message Status: {status_code} - Response: {response_text}
	Centred True
	Location system_tray
	MessageType Information
	CardPosX 410
	CardPosY 50